<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doctor Appointments</title>
  <!-- Auto-refresh the page every 5 seconds -->
  <meta http-equiv="refresh" content="5">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .nav-link.active {
      font-weight: bold;
    }
    /* Custom badge styles for appointment statuses */
    .badge-pending {
      background-color: #ffc107; /* warning yellow */
      color: #212529; /* dark text */
    }
    .badge-confirmed {
      background-color: #198754; /* success green */
      color: #fff;
    }
    .badge-cancelled {
      background-color: #dc3545; /* danger red */
      color: #fff;
    }
    .badge-completed {
      background-color: #0d6efd; /* info blue for completed */
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="d-flex">
    <nav class="bg-dark text-white p-3 vh-100 rounded-tr-xl rounded-br-xl" style="width: 250px;">
      <h4 class="mb-4">ApkaDr.</h4>
      <ul class="nav flex-column mt-4">
        <li class="nav-item"><a class="nav-link text-white rounded-md hover:bg-gray-700 transition duration-300" href="{{ url_for('doctor_dashboard', user_id=session.get('user_id')) }}">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link text-white active rounded-md hover:bg-gray-700 transition duration-300" href="{{ url_for('doctor_appointments', user_id=session.get('user_id')) }}">Appointments</a></li>
        <li class="nav-item"><a class="nav-link text-white rounded-md hover:bg-gray-700 transition duration-300" href="{{ url_for('doctor_profile', user_id=session.get('user_id')) }}">My Profile</a></li>
        <li class="nav-item"><a class="nav-link text-white rounded-md hover:bg-gray-700 transition duration-300" href="{{ url_for('logout') }}">Logout</a></li>
      </ul>
    </nav>

    <main class="p-4 w-100">
      <!-- Flash messages for user feedback -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show rounded-md" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <h2 class="mb-4 text-3xl font-bold">Manage Appointments</h2>
      <table class="table mt-4 table-striped table-hover rounded-md overflow-hidden shadow-sm">
        <thead class="bg-gray-800 text-white">
          <tr>
            <th scope="col" class="py-3 px-4">Patient Name</th>
            <th scope="col" class="py-3 px-4">Date</th>
            <th scope="col" class="py-3 px-4">Time</th>
            <th scope="col" class="py-3 px-4">Symptoms</th>
            <th scope="col" class="py-3 px-4">Status</th>
            <th scope="col" class="py-3 px-4">Token Number</th>
            <th scope="col" class="py-3 px-4">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for appointment in appointments %}
          <tr class="hover:bg-gray-50">
            <td class="py-3 px-4">{{ appointment.patient.fullName if appointment.patient else 'N/A' }}</td>
            <td class="py-3 px-4">
              {% if appointment.appointment_date %}
                {{ appointment.appointment_date.strftime('%Y-%m-%d') }}
              {% else %}
                N/A
              {% endif %}
            </td>
            <td class="py-3 px-4">{{ appointment.appointment_time if appointment.appointment_time else 'N/A' }}</td>
            <td class="py-3 px-4">
              <!-- If symptoms contain "Patient: " it means it was booked for someone else -->
              {% if "Patient:" in appointment.symptoms %}
                  {% set patient_details = appointment.symptoms.split(',') %}
                  {% set patient_name_line = patient_details[0] %}
                  {{ patient_name_line.replace('Patient:', '').strip() }} - (Other)
              {% else %}
                  {{ appointment.symptoms }}
              {% endif %}
            </td>
            <td class="py-3 px-4">
              <!-- Conditional badge styling based on appointment status -->
              {% if appointment.status == 'pending' %}
                <span class="badge badge-pending rounded-pill px-3 py-2">Pending</span>
              {% elif appointment.status == 'confirmed' %}
                <span class="badge badge-confirmed rounded-pill px-3 py-2">Confirmed</span>
              {% elif appointment.status == 'cancelled' %}
                <span class="badge badge-cancelled rounded-pill px-3 py-2">Cancelled</span>
              {% elif appointment.status == 'completed' %}
                <span class="badge badge-completed rounded-pill px-3 py-2">Completed</span>
              {% else %}
                <span class="badge bg-secondary rounded-pill px-3 py-2">{{ appointment.status.capitalize() }}</span>
              {% endif %}
            </td>
            <td class="py-3 px-4">{{ appointment.token_number if appointment.token_number else '--' }}</td>
            <td class="py-3 px-4">
              <!-- Conditional action buttons for pending and confirmed appointments -->
              {% if appointment.status == 'pending' %}
                <form action="{{ url_for('confirm_appointment_by_doctor', appointment_id=appointment.id) }}"
                    method="POST" class="d-inline-flex align-items-center">
                    <input type="text" name="token_number" class="form-control form-control-sm me-2"
                        placeholder="Enter Token" required style="width: 120px;">
                    <button type="submit" class="btn btn-success btn-sm me-2 rounded-md hover:shadow-lg transition duration-300">Confirm</button>
                </form>
                <a href="{{ url_for('cancel_appointment_by_doctor', appointment_id=appointment.id) }}" class="btn btn-danger btn-sm rounded-md hover:shadow-lg transition duration-300">Cancel</a>
              {% elif appointment.status == 'confirmed' %}
                <button class="btn btn-secondary btn-sm rounded-md" disabled>Confirmed</button>
                <a href="{{ url_for('cancel_appointment_by_doctor', appointment_id=appointment.id) }}" class="btn btn-danger btn-sm rounded-md hover:shadow-lg transition duration-300">Cancel</a>
              {% elif appointment.status == 'cancelled' %}
                <button class="btn btn-warning btn-sm rounded-md" disabled>Cancelled</button>
              {% elif appointment.status == 'completed' %}
                <button class="btn btn-primary btn-sm rounded-md" disabled>Completed</button>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <!-- Message if no appointments are found -->
          <tr>
            <td colspan="7" class="text-center py-4 text-gray-500">No appointments found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </main>
  </div>
  <!-- Bootstrap JS Bundle with Popper for interactive components -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
